{% extends "base.html" %}

{% block title %}{{ title }} - Markdown Notes{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h2>{{ title }}</h2>
    <div>
        {% if is_editing and note and note.id %}
        <a href="/notes/{{ note.id }}/preview" class="btn btn-secondary" target="_blank">Preview</a>
        {% endif %}
        <a href="/notes" class="btn btn-secondary">Back to Notes</a>
    </div>
</div>

{% if error %}
<div class="message error">
    {{ error }}
</div>
{% endif %}

{% if message %}
<div class="message">
    {{ message }}
</div>
{% endif %}

<form method="post" action="{% if is_editing and note and note.id %}/notes/{{ note.id }}{% else %}/notes{% endif %}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    
    <div class="form-group">
        <label for="title">Title:</label>
        <input type="text" id="title" name="title" value="{{ note.title if note else '' }}" required maxlength="255">
    </div>
    
    <div class="editor-container">
        <div class="editor-panel">
            <h3>Editor</h3>
            <div class="content">
                <textarea id="markdown-content" name="content" placeholder="Write your markdown here...">{{ note.content if note else '' }}</textarea>
            </div>
        </div>
        
        <div class="editor-panel">
            <h3>Preview</h3>
            <div class="content">
                <div id="preview-content" class="preview-content">
                    <p style="color: #6c757d; font-style: italic;">Start typing to see preview...</p>
                </div>
            </div>
        </div>
    </div>
    
    <div style="margin-top: 1rem; display: flex; gap: 1rem;">
        <button type="submit" class="btn">
            {% if is_editing %}Update Note{% else %}Create Note{% endif %}
        </button>
        <a href="/notes" class="btn btn-secondary">Cancel</a>
        {% if is_editing and note and note.id %}
        <button type="button" onclick="deleteNote('{{ note.id }}')" class="btn btn-danger" style="margin-left: auto;">Delete Note</button>
        {% endif %}
    </div>
</form>

<script>
// Enhanced editor functionality
document.addEventListener('DOMContentLoaded', function() {
    const markdownEditor = document.querySelector('#markdown-content');
    const previewPane = document.querySelector('#preview-content');
    
    if (markdownEditor && previewPane) {
        // Initial preview
        updatePreview();
        
        // Update preview on input
        markdownEditor.addEventListener('input', debounce(updatePreview, 300));
    }
    
    async function updatePreview() {
        const content = markdownEditor.value.trim();
        
        if (!content) {
            previewPane.innerHTML = '<p style="color: #6c757d; font-style: italic;">Start typing to see preview...</p>';
            return;
        }
        
        try {
            const noteId = '{% if note and note.id %}{{ note.id }}{% else %}preview{% endif %}';
            const response = await fetch(`/api/notes/${noteId}/preview`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ content: content })
            });
            
            if (response.ok) {
                const data = await response.json();
                previewPane.innerHTML = data.html;
            } else {
                previewPane.innerHTML = '<p style="color: #dc3545;">Error loading preview</p>';
            }
        } catch (error) {
            previewPane.innerHTML = '<p style="color: #dc3545;">Error loading preview: ' + error.message + '</p>';
        }
    }
    
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    // Auto-resize textarea
    markdownEditor.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = this.scrollHeight + 'px';
    });
    
    // Tab key support in textarea
    markdownEditor.addEventListener('keydown', function(e) {
        if (e.key === 'Tab') {
            e.preventDefault();
            const start = this.selectionStart;
            const end = this.selectionEnd;
            
            // Insert tab character
            this.value = this.value.substring(0, start) + '\t' + this.value.substring(end);
            this.selectionStart = this.selectionEnd = start + 1;
            
            // Trigger preview update
            updatePreview();
        }
    });
});

async function deleteNote(noteId) {
    if (!confirm('Are you sure you want to delete this note? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/notes/${noteId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            window.location.href = '/notes';
        } else {
            alert('Failed to delete note');
        }
    } catch (error) {
        alert('Error deleting note: ' + error.message);
    }
}

// Save shortcut (Ctrl+S)
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        document.querySelector('form').submit();
    }
});
</script>
{% endblock %}