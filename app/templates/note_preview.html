{% extends "base.html" %}

{% block title %}{{ title }} - Markdown Notes{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <div>
        <h2 data-encrypted-title="{{ note.title | e }}"></h2>
        <div style="color: var(--text-muted); font-size: 0.9rem;">
            Created: {{ note.created_at.strftime('%Y-%m-%d %H:%M') }} | 
            Updated: {{ note.updated_at.strftime('%Y-%m-%d %H:%M') }}
        </div>
    </div>
    <div>
        <a href="/notes/{{ note.id }}" class="btn">Edit</a>
        <button onclick="downloadNote('{{ note.id }}')" class="btn btn-secondary">Download</button>
        <a href="/notes" class="btn btn-secondary">Back</a>
    </div>
</div>

    <div class="preview-container">
    <div class="preview-content" data-encrypted-html="{{ html_content | e }}">
        <div style="text-align: center; padding: 2rem; color: #6c757d;">
            <div style="margin-bottom: 1rem;">üîì Decrypting content...</div>
            <div style="font-size: 0.875rem;">Please wait while the content is being decrypted.</div>
        </div>
    </div>
</div>

<style>
.preview-container {
    background-color: var(--surface);
    border-radius: 8px;
    padding: 2rem;
    box-shadow: var(--shadow);
    max-width: none;
}

.preview-content {
    font-size: 16px;
    line-height: 1.6;
    color: var(--text);
}

.preview-content h1,
.preview-content h2,
.preview-content h3,
.preview-content h4,
.preview-content h5,
.preview-content h6 {
    margin-top: 2rem;
    margin-bottom: 1rem;
    color: var(--text-strong);
    line-height: 1.3;
}

.preview-content h1 {
    font-size: 2.25rem;
    border-bottom: 2px solid var(--border);
    padding-bottom: 0.5rem;
}

.preview-content h2 {
    font-size: 1.875rem;
    border-bottom: 1px solid var(--border);
    padding-bottom: 0.25rem;
}

.preview-content h3 {
    font-size: 1.5rem;
}

.preview-content h4 {
    font-size: 1.25rem;
}

.preview-content h5 {
    font-size: 1.125rem;
}

.preview-content h6 {
    font-size: 1rem;
}

.preview-content p {
    margin-bottom: 1rem;
    text-align: justify;
}

.preview-content ul,
.preview-content ol {
    margin-bottom: 1rem;
    padding-left: 2rem;
}

.preview-content li {
    margin-bottom: 0.5rem;
}

.preview-content code {
    background-color: var(--bg);
    padding: 0.2rem 0.4rem;
    border-radius: 3px;
    font-family: 'Courier New', 'Monaco', 'Menlo', monospace;
    font-size: 0.9em;
    color: #e83e8c;
}

.preview-content pre {
    background-color: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    padding: 1rem;
    overflow-x: auto;
    margin-bottom: 1rem;
    line-height: 1.4;
}

.preview-content pre code {
    background-color: transparent;
    padding: 0;
    color: var(--text);
    font-size: 0.875rem;
}

.preview-content blockquote {
    border-left: 4px solid var(--primary);
    padding-left: 1rem;
    margin: 1.5rem 0;
    color: var(--text-muted);
    font-style: italic;
}

.preview-content table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 1rem;
    border: 1px solid var(--border);
}

.preview-content table th,
.preview-content table td {
    padding: 0.75rem;
    border: 1px solid var(--border);
    text-align: left;
}

.preview-content table th {
    background-color: var(--bg);
    font-weight: 600;
}

.preview-content table tbody tr:nth-child(odd) {
    background-color: color-mix(in srgb, var(--text) 5%, transparent);
}

.preview-content img {
    max-width: 100%;
    height: auto;
    border-radius: 4px;
    box-shadow: var(--shadow);
    margin: 1rem 0;
}

.preview-content a {
    color: var(--primary);
    text-decoration: none;
}

.preview-content a:hover {
    text-decoration: underline;
}

.preview-content hr {
    border: 0;
    border-top: 1px solid var(--border);
    margin: 2rem 0;
}

/* Code highlighting */
.preview-content .codehilite {
    background-color: var(--bg);
    border: 1px solid var(--border);
    border-radius: 4px;
    margin-bottom: 1rem;
}

.preview-content .codehilite pre {
    background-color: transparent;
    border: none;
    margin: 0;
}

@media (max-width: 768px) {
    .preview-container {
        padding: 1rem;
        margin: 0 -1rem;
        border-radius: 0;
    }
    
    .preview-content {
        font-size: 15px;
    }
    
    .preview-content h1 {
        font-size: 1.875rem;
    }
    
    .preview-content h2 {
        font-size: 1.5rem;
    }
    
    .preview-content table {
        font-size: 0.875rem;
    }
    
    .preview-content table th,
    .preview-content table td {
        padding: 0.5rem;
    }
}
</style>

<script src="/static/js/crypto.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async function() {
    // // Check if crypto is supported
    // if (!window.NoteCrypto || !window.NoteCrypto.isCryptoSupported()) {
    //     alert('This browser does not support the required encryption features. Please use a modern browser.');
    //     return;
    // }

    try {
        // Decrypt title
        const titleElement = document.querySelector('h2[data-encrypted-title]');
        if (titleElement) {
            const encryptedTitle = titleElement.getAttribute('data-encrypted-title');
            const decryptedTitle = await window.NoteCrypto.decryptData(encryptedTitle);
            titleElement.textContent = decryptedTitle;
        }

        // Decrypt HTML content
        const contentElement = document.querySelector('.preview-content[data-encrypted-html]');
        if (contentElement) {
            const encryptedHtml = contentElement.getAttribute('data-encrypted-html');
            const decryptedHtml = await window.NoteCrypto.decryptData(encryptedHtml);
            contentElement.innerHTML = decryptedHtml;
        }
    } catch (error) {
        window.NoteCrypto.showCryptoError('Failed to decrypt preview content: ' + error.message);
        
        // Show error in content area
        const contentElement = document.querySelector('.preview-content');
        if (contentElement) {
            contentElement.innerHTML = `
                <div style="text-align: center; padding: 2rem; color: #dc3545;">
                    <div style="margin-bottom: 1rem;">‚ùå Decryption Error</div>
                    <div style="font-size: 0.875rem;">Failed to decrypt the content. Please refresh the page and try again.</div>
                </div>
            `;
        }
    }
});

function sanitizeFilename(name) {
    // Allow Unicode characters; remove only illegal filename chars and control chars
    // 1) Strip control chars
    let safe = String(name || '').replace(/[\u0000-\u001F\u007F]/g, '');
    // 2) Replace characters not allowed on Windows/macOS
    safe = safe.replace(/[<>:"/\\|?*]/g, '-');
    // 3) Collapse whitespace and trim
    safe = safe.replace(/\s+/g, ' ').trim();
    // 4) Avoid reserved Windows device names
    const reserved = /^(con|prn|aux|nul|com[1-9]|lpt[1-9])(\..*)?$/i;
    if (reserved.test(safe)) {
        safe = '_' + safe;
    }
    // 5) Remove trailing dots/spaces
    safe = safe.replace(/[ .]+$/g, '');
    // 6) Enforce max filename length, preserving extension if present
    if (!safe) safe = 'note';
    const MAX = 120;
    if (safe.length > MAX) {
        const m = safe.match(/(\.[^.]{1,15})$/); // keep short extension if exists
        const ext = m ? m[1] : '';
        const base = safe.slice(0, MAX - ext.length);
        safe = base + ext;
    }
    return safe;
}

async function downloadNote(noteId) {
    try {
        const res = await fetch(`/api/notes/${noteId}`);
        if (!res.ok) throw new Error('Failed to fetch note');
        const data = await res.json();
        const title = await window.NoteCrypto.decryptData(data.title);
        const content = await window.NoteCrypto.decryptData(data.content);
        const filename = sanitizeFilename(title) + '.md';
        const blob = new Blob([content], { type: 'text/markdown;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
    } catch (error) {
        window.NoteCrypto.showCryptoError('Download failed: ' + error.message);
    }
}
</script>
{% endblock %}
