{% extends "base.html" %}

{% block title %}{{ title }} - Markdown Notes{% endblock %}

{% block content %}
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
    <h2>{{ title }}</h2>
    <div style="display: flex; gap: 0.5rem; align-items: center;">
        <button type="submit" class="btn" form="note-form">
            {% if is_editing %}Update Note{% else %}Create Note{% endif %}
        </button>
        {% if is_editing and note and note.id %}
        <button type="button" onclick="deleteNote('{{ note.id }}')" class="btn btn-danger">Delete Note</button>
        {% endif %}
        {% if is_editing and note and note.id %}
        <a href="/notes/{{ note.id }}/preview" class="btn btn-secondary" target="_blank" onclick="return confirmPreview(event, '/notes/{{ note.id }}/preview')">Preview</a>
        {% endif %}
        <a href="/notes" class="btn btn-secondary" onclick="return confirmNavigation(event, '/notes')">Back to Notes</a>
    </div>
</div>

{% if error %}
<div class="message error">
    {{ error }}
</div>
{% endif %}

{% if message %}
<div class="message">
    {{ message }}
</div>
{% endif %}

<form id="note-form" method="post" action="{% if is_editing and note and note.id %}/notes/{{ note.id }}{% else %}/notes{% endif %}">
    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
    
    <div class="form-group">
        <label for="title">Title:</label>
        <input type="text" id="title" name="title" value="{{ note.title if note else '' }}" required maxlength="255">
    </div>
    
    <div class="form-group">
        <label for="content">Content:</label>
        <textarea id="markdown-content" name="content" placeholder="Write your markdown here...">{{ note.content if note else '' }}</textarea>
    </div>
</form>

<script>
// Enhanced editor functionality with unsaved changes protection
document.addEventListener('DOMContentLoaded', function() {
    const markdownEditor = document.querySelector('#markdown-content');
    const titleInput = document.querySelector('#title');
    const form = document.querySelector('#note-form');
    
    // Track form state
    let originalFormState = {};
    let hasUnsavedChanges = false;
    let isSubmitting = false;
    
    if (markdownEditor && titleInput) {
        // Store original form state
        originalFormState = {
            title: titleInput.value,
            content: markdownEditor.value
        };
        
        // Check for unsaved changes
        function checkForChanges() {
            const currentState = {
                title: titleInput.value,
                content: markdownEditor.value
            };
            
            hasUnsavedChanges = (
                currentState.title !== originalFormState.title ||
                currentState.content !== originalFormState.content
            );
        }
        
        // Auto-resize textarea and check for changes
        markdownEditor.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
            checkForChanges();
        });
        
        // Check for changes on title input
        titleInput.addEventListener('input', checkForChanges);
        
        // Tab key support in textarea
        markdownEditor.addEventListener('keydown', function(e) {
            if (e.key === 'Tab') {
                e.preventDefault();
                const start = this.selectionStart;
                const end = this.selectionEnd;
                
                // Insert tab character
                this.value = this.value.substring(0, start) + '\t' + this.value.substring(end);
                this.selectionStart = this.selectionEnd = start + 1;
                checkForChanges();
            }
        });
    }
    
    // Form submission handler
    if (form) {
        form.addEventListener('submit', function() {
            isSubmitting = true;
            hasUnsavedChanges = false;
        });
    }
    
    // Make functions available globally
    window.hasUnsavedChanges = function() {
        return hasUnsavedChanges && !isSubmitting;
    };
    
    window.clearUnsavedChanges = function() {
        hasUnsavedChanges = false;
        originalFormState = {
            title: titleInput.value,
            content: markdownEditor.value
        };
    };
    
    // Browser navigation warning (beforeunload)
    window.addEventListener('beforeunload', function(e) {
        if (window.hasUnsavedChanges()) {
            e.preventDefault();
            e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            return e.returnValue;
        }
    });
});

// Navigation confirmation helper
function confirmNavigation(event, targetUrl) {
    if (window.hasUnsavedChanges()) {
        event.preventDefault();
        if (confirm('You have unsaved changes. Are you sure you want to leave without saving?')) {
            window.location.href = targetUrl;
        }
        return false;
    }
    return true;
}

// Preview confirmation helper
function confirmPreview(event, targetUrl) {
    if (window.hasUnsavedChanges()) {
        event.preventDefault();
        if (confirm('You have unsaved changes. Are you sure you want to open preview without saving?')) {
            window.open(targetUrl, '_blank');
        }
        return false;
    }
    return true;
}

async function deleteNote(noteId) {
    if (!confirm('Are you sure you want to delete this note? This action cannot be undone.')) {
        return;
    }
    
    try {
        const response = await fetch(`/notes/${noteId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            window.location.href = '/notes';
        } else {
            alert('Failed to delete note');
        }
    } catch (error) {
        alert('Error deleting note: ' + error.message);
    }
}

// Save shortcut (Ctrl+S)
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        document.querySelector('form').submit();
    }
});
</script>
{% endblock %}